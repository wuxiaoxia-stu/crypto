# -*- coding: utf-8 -*-

from netcacrypto import SignedData, EnvelopedData,Certificate
import base64
import os, re
import time
import string

'''
用于循环跑脚本，测试循环调用是否存在内存溢出问题
'''

def verify_signedData():
	signed_data_base64="MIIEcQYJKoZIhvcNAQcCoIIEYjCCBF4CAQExDDAKBggqgRzPVQGDETALBgkqhkiG9w0BBwGgggL2MIIC8jCCApigAwIBAgIUCHVIQkL71/bh7NSORmDwAtaimb4wCgYIKoEcz1UBg3UwVTELMAkGA1UEBhMCQ04xJDAiBgNVBAoMG05FVENBIENlcnRpZmljYXRlIEF1dGhvcml0eTEgMB4GA1UEAwwXTkVUQ0FfVGVzdDIwMTkgU00yIENBMDEwHhcNMjAwOTExMTAwODE0WhcNMjExMjMxMTYwMDAwWjBXMQswCQYDVQQGEwJDTjESMBAGA1UECAwJR3Vhbmdkb25nMQ4wDAYDVQQHDAVnejIyMjERMA8GA1UECgwIY25jYS1zbTIxETAPBgNVBAMMCGNuY2Etc20yMFkwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQgAE16GQ5MdIm4+JsYU5cKctY/i45J2pK6H5IdvUiiXS/LK13UhXPW674b1skNiD0Ehjv/Gdvk8vPQyfjhcuOA4jzKOCAUIwggE+MIGHBggrBgEFBQcBAQR7MHkwOQYIKwYBBQUHMAGGLWh0dHA6Ly9sYW9jc3AuY25jYS5uZXQvb2NzcG1hbmFnZXIvb2NzcC9jaGVjazA8BggrBgEFBQcwAoYwaHR0cDovL2xhY2EuY25jYS5uZXQvbGFjYS9DQ1NORVRDQVNNMlJPT1RMQTEuY2VyMB0GA1UdDgQWBBRACMng8uZpvKAOfisuVp1iXSMKHzAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH/BAIwADBUBgNVHR8ETTBLMEmgR6BFhkNodHRwOi8vMTkyLjE2OC4yMDAuMTAxOjgwODAvY2FhZG1pbi9jb25maWdjcmx0ZW1wbGF0ZS9kb3dubG9hZENybC8xMB8GA1UdIwQYMBaAFNBBHunn3uwo364nD8m2qyrPEZ08MAoGCCqBHM9VAYN1A0gAMEUCIQCjO6qZoRnBO8jOHgk8bcPZm9CMYlrsoam4Li+0xVZMDwIgCnqMo8eo/DgX5qDBJWZAHe48p9GVgYFeJuPV85h1XIUxggFCMIIBPgIBATBtMFUxCzAJBgNVBAYTAkNOMSQwIgYDVQQKDBtORVRDQSBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkxIDAeBgNVBAMMF05FVENBX1Rlc3QyMDE5IFNNMiBDQTAxAhQIdUhCQvvX9uHs1I5GYPAC1qKZvjAKBggqgRzPVQGDEaBpMBgGCSqGSIb3DQEJAzELBgkqhkiG9w0BBwEwHAYJKoZIhvcNAQkFMQ8XDTIwMDkyMTAyMDgxOVowLwYJKoZIhvcNAQkEMSIEIFMO5y6e0OgBJfSpxs4tsQYVArnOdg2leLeVZtiuKIFvMAoGCCqBHM9VAYN1BEcwRQIhAJ9DUlLR3/EzgpD6Sm1ZUHEAbC2dW5Uc1m5DxsPPzXSjAiA4HGwgojZcNubSpbIrvbf/HFP/w/zd/Gj9xrRFq9TTHw=="
	origin="1234"

	tbs_data=origin.encode("utf-8")
	sign_data=base64.b64decode(signed_data_base64)
	with SignedData.verify_data(tbs_data,sign_data) as cert_obj:
		subject=cert_obj.get_subject()
		print("sign cert subject:\t"+subject)


def envlopedData():
	origin="1234!@#$%"
	envcert_base64="MIIEcDCCA1igAwIBAgILIJBc7LNr6GXGSGswDQYJKoZIhvcNAQELBQAwUjELMAkGA1UEBhMCQ04xJDAiBgNVBAoMG05FVENBIENlcnRpZmljYXRlIEF1dGhvcml0eTEdMBsGA1UEAwwUQ0NTIE5FVENBIFQyIFN1YjEgQ0EwHhcNMjAwODAzMDIxNzQ0WhcNMjUwMzE4MDEzMTMzWjBZMQwwCgYDVQQHDAM3NzcxDDAKBgNVBAsMAzc3NzELMAkGA1UEBhMCQ04xEjAQBgNVBAgMCUd1YW5nZG9uZzEMMAoGA1UECgwDNzc3MQwwCgYDVQQDDAM3NzcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCv6BEQzDgTYm7WIQXFG61X6ZWe5/NLp7fF+hnsML2yajNqqaTqY5MC3cER7B+1ZCvhNd3SCBnJOhn0gkaIp8QzfmLeq30MoQQGaw9MdeWW0J5CZvZ2sMZECTInMFyb4QJmmut4vBxIkV2+xRkw4ZUWxyT23EB+0jG5Q/8R+/s85xGWMuI/rMv57Jc6FOA58RngD7+dU/hWIdSqecD1WTxoeQGM//PsSIHs1KuBUzt2qJkVbkODcdz1EJ5mlQuBzOJ7h5tSEzBuVlviOLRRvRaqYZJaKPU3pZHrL3iMiy0DVRPYZxdxBWTvddF54KkagPEasjc8GkKispjB3pk0pCyPAgMBAAGjggE+MIIBOjAfBgNVHSMEGDAWgBQGuR/VnbIM8cSEdELCMCXiCdpW2DAdBgNVHQ4EFgQUmgxd2F6SZfrZZlNPq4n0NpVpZLcwbAYDVR0gBGUwYzBhBgsrBgEEAYGSSAIKAjBSMFAGCCsGAQUFBwIBFkRodHRwOi8vd3d3LmNuY2EubmV0L2NzL2tub3dsZWRnZS93aGl0ZXBhcGVyL2Nwcy9uZXRDQXRlc3RjZXJ0Y3BzLnBkZjAMBgNVHRMBAf8EAjAAMA4GA1UdDwEB/wQEAwIDODBsBgNVHR8EZTBjMGGgX6Bdhi1odHRwOi8vdGVzdC5jbmNhLm5ldC9jcmwvQ0NTTkVUQ0FUMlN1YjFDQS5jcmyGLGh0dHA6Ly8xOTIuMTY4LjAuMjgvY3JsL0NDU05FVENBVDJTdWIxQ0EuY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQCcXG2AI+WUcJdaBuhDtmNyK6NZs6K/A1A2ObdK8jUwScM7jUthr/k/h5k1c1hxJcR0o3PdG/kdC7XMQB5Z1NSP+ft5NZINEJxicP6OYR27UyUI+caMvUvFZzj4cusYRpKqg8gEhEhSLHNaHCUOgxWA8SxF5/BJbA5YgY3fYeHkOJKdYxucdbAMSDVoA4ILY+Zt5pSpi6EOVY/vLjKuwAeLhpsVRTNgwUGq9CoDrIEVxLfXIXL8OB4acU9E/B2JsyvjNNPkkZdLaOUHHThjxpi/ZqH940YDD9ZYge33IySj+CyPNeMLTW3pHqaW1lsssPtXrWGKa2V2jsbCkKGjIv4A"
	cert_obj=Certificate(envcert_base64)
	#print(cert.get_subject())
	tbs_data=origin.encode("utf-8")
	#with EnvelopedData.encrypt_data(cert, tbs_data) as envdata:
	with cert_obj:
		env_data=EnvelopedData.encrypt_data(cert_obj,tbs_data)
		print(base64.b64encode(env_data))

def decrypt_envlopedData():
	origin=""
	envdata_base64="MIIBiAYJKoZIhvcNAQcDoIIBeTCCAXUCAQIxggEwMIIBLAIBAoAUmgxd2F6SZfrZZlNPq4n0NpVpZLcwDQYJKoZIhvcNAQEBBQAEggEARNvl5Q8Sk9z6u+qVVHQNWhPm13YVQow3HTHsk8z93JAw2xh3qehwWNs13HmQjWB7Nw6XRiIC2osC+OFsCaEfx7GUm0arsv6dfmZoHuI7QLkfpX3SsLE24nFK1+oKMk1Knp4P96PHNJKmtij7pDmQ9lR+bVnUCOCShqbK/SSQ9aEFbhmv54YV2iHuVldubE02/bK5SKJsAGsG7fTe1Ts+3Y8AkS5LCv6Fr+0011jEhlS8VI7VN6NqOQnHy0Nvch6fQSJh8DM44hMAafrA4H411CmkdJ2o7Gc0MFsiBbKPFLk/pHWAzeV6pkWOUnkWbPkTaqIsUoC6M63SS/slr4R63DA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBAGW7BlHpQOCY/wb4EtnQzMgBBZiDRZpsAlh8k6ob8AAqnh"
	envcert_base64="MIIEcDCCA1igAwIBAgILIJBc7LNr6GXGSGswDQYJKoZIhvcNAQELBQAwUjELMAkGA1UEBhMCQ04xJDAiBgNVBAoMG05FVENBIENlcnRpZmljYXRlIEF1dGhvcml0eTEdMBsGA1UEAwwUQ0NTIE5FVENBIFQyIFN1YjEgQ0EwHhcNMjAwODAzMDIxNzQ0WhcNMjUwMzE4MDEzMTMzWjBZMQwwCgYDVQQHDAM3NzcxDDAKBgNVBAsMAzc3NzELMAkGA1UEBhMCQ04xEjAQBgNVBAgMCUd1YW5nZG9uZzEMMAoGA1UECgwDNzc3MQwwCgYDVQQDDAM3NzcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCv6BEQzDgTYm7WIQXFG61X6ZWe5/NLp7fF+hnsML2yajNqqaTqY5MC3cER7B+1ZCvhNd3SCBnJOhn0gkaIp8QzfmLeq30MoQQGaw9MdeWW0J5CZvZ2sMZECTInMFyb4QJmmut4vBxIkV2+xRkw4ZUWxyT23EB+0jG5Q/8R+/s85xGWMuI/rMv57Jc6FOA58RngD7+dU/hWIdSqecD1WTxoeQGM//PsSIHs1KuBUzt2qJkVbkODcdz1EJ5mlQuBzOJ7h5tSEzBuVlviOLRRvRaqYZJaKPU3pZHrL3iMiy0DVRPYZxdxBWTvddF54KkagPEasjc8GkKispjB3pk0pCyPAgMBAAGjggE+MIIBOjAfBgNVHSMEGDAWgBQGuR/VnbIM8cSEdELCMCXiCdpW2DAdBgNVHQ4EFgQUmgxd2F6SZfrZZlNPq4n0NpVpZLcwbAYDVR0gBGUwYzBhBgsrBgEEAYGSSAIKAjBSMFAGCCsGAQUFBwIBFkRodHRwOi8vd3d3LmNuY2EubmV0L2NzL2tub3dsZWRnZS93aGl0ZXBhcGVyL2Nwcy9uZXRDQXRlc3RjZXJ0Y3BzLnBkZjAMBgNVHRMBAf8EAjAAMA4GA1UdDwEB/wQEAwIDODBsBgNVHR8EZTBjMGGgX6Bdhi1odHRwOi8vdGVzdC5jbmNhLm5ldC9jcmwvQ0NTTkVUQ0FUMlN1YjFDQS5jcmyGLGh0dHA6Ly8xOTIuMTY4LjAuMjgvY3JsL0NDU05FVENBVDJTdWIxQ0EuY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQCcXG2AI+WUcJdaBuhDtmNyK6NZs6K/A1A2ObdK8jUwScM7jUthr/k/h5k1c1hxJcR0o3PdG/kdC7XMQB5Z1NSP+ft5NZINEJxicP6OYR27UyUI+caMvUvFZzj4cusYRpKqg8gEhEhSLHNaHCUOgxWA8SxF5/BJbA5YgY3fYeHkOJKdYxucdbAMSDVoA4ILY+Zt5pSpi6EOVY/vLjKuwAeLhpsVRTNgwUGq9CoDrIEVxLfXIXL8OB4acU9E/B2JsyvjNNPkkZdLaOUHHThjxpi/ZqH940YDD9ZYge33IySj+CyPNeMLTW3pHqaW1lsssPtXrWGKa2V2jsbCkKGjIv4A"
	with Certificate(envcert_base64) as cert_obj:
		cert_obj.get_privatekey("12345678")
		EnvelopedData.set_decrypt_cert(cert_obj)
		clear_data=EnvelopedData.decrypt_data(base64.b64decode(envdata_base64))
		print(clear_data)

def signedData():
	tbs_data="1234asdff".encode("utf-8")
	signcert_base64="MIIEcDCCA1igAwIBAgILELnluIIoxbefNFkwDQYJKoZIhvcNAQELBQAwUjELMAkGA1UEBhMCQ04xJDAiBgNVBAoMG05FVENBIENlcnRpZmljYXRlIEF1dGhvcml0eTEdMBsGA1UEAwwUQ0NTIE5FVENBIFQyIFN1YjEgQ0EwHhcNMjAwODAzMDIxNzQ0WhcNMjUwMzE4MDEzMTMzWjBZMQwwCgYDVQQHDAM3NzcxDDAKBgNVBAsMAzc3NzELMAkGA1UEBhMCQ04xEjAQBgNVBAgMCUd1YW5nZG9uZzEMMAoGA1UECgwDNzc3MQwwCgYDVQQDDAM3NzcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCzQoGPL7ycwZeqt+TUP308IX1VgwN8H3O8gsBfkEb+K2RsoGgytPtRAgNCPgr6nc90AqC1O6Om/wsqdBHz1w1f6WJb25a0mh18W7c+D05/4cbcpD1xxtc8U2tYGoiTRvbHaApEJfaQ/dWKxRujFsoBYxcnavMoEKm8vSJ/jNRS/mEODQU5L0KGZHUbMAllJLsVYdRn8yvHcNasYkeJrsJwF3aUG45XxMNoN1h6xda7jhQZ5AFhNJpNph0hna5F4Gtf9jo8MMQ2p3eYQaGclvV/C/8n4dt+Wvb/SHeseeAv3UnemKsGDeikjJ4aunWp9TVMB59salUu1TPh8tjRWwpXAgMBAAGjggE+MIIBOjAfBgNVHSMEGDAWgBQGuR/VnbIM8cSEdELCMCXiCdpW2DAdBgNVHQ4EFgQUS+LsjNKsyRyHHiHGBo9tz2ulftEwbAYDVR0gBGUwYzBhBgsrBgEEAYGSSAIKAjBSMFAGCCsGAQUFBwIBFkRodHRwOi8vd3d3LmNuY2EubmV0L2NzL2tub3dsZWRnZS93aGl0ZXBhcGVyL2Nwcy9uZXRDQXRlc3RjZXJ0Y3BzLnBkZjAMBgNVHRMBAf8EAjAAMA4GA1UdDwEB/wQEAwIGwDBsBgNVHR8EZTBjMGGgX6Bdhi1odHRwOi8vdGVzdC5jbmNhLm5ldC9jcmwvQ0NTTkVUQ0FUMlN1YjFDQS5jcmyGLGh0dHA6Ly8xOTIuMTY4LjAuMjgvY3JsL0NDU05FVENBVDJTdWIxQ0EuY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQA7nJJqJa3PXXTw1tPzTxG6nxSirr+68+jHWHOvgwJ2EiW8vkl7ln+s3xf5H8cA6u3oKQ9C0lA597E2Y49BQ7m9q8YgLxpkT2RpTXaGtBKpKbZOCZAQZF0bD/4KEtaKH0Z9lSKRfQjknOjidrJvVs0AO4qCNAslboK0O7mhDgwjUr7dsiL6pwQZ7N646Z2G05xiLLeSU0+eeOU2s2Vla1aIqX9LHwB2vX4jMgZLLiF1FcFBkSZuHmaUOp3GNfdVms3JKpLUr91drelEadlRTNlmGpOUz4PQKXhIyMI+g5tO5pMrv/OyjM82RY2BQw3UmWFBIxbDor1vV64RiPvqfxTD"
	detached=False
	with Certificate(signcert_base64) as cert_obj:
		cert_obj.get_privatekey("12345678")
		sign_data=SignedData.sign_data(cert_obj,detached,tbs_data)
		print(cert_obj.get_subject())
		
		
def sign():
	tbs_data="1234asdff".encode("utf-8")
	signcert_base64="MIIEcDCCA1igAwIBAgILELnluIIoxbefNFkwDQYJKoZIhvcNAQELBQAwUjELMAkGA1UEBhMCQ04xJDAiBgNVBAoMG05FVENBIENlcnRpZmljYXRlIEF1dGhvcml0eTEdMBsGA1UEAwwUQ0NTIE5FVENBIFQyIFN1YjEgQ0EwHhcNMjAwODAzMDIxNzQ0WhcNMjUwMzE4MDEzMTMzWjBZMQwwCgYDVQQHDAM3NzcxDDAKBgNVBAsMAzc3NzELMAkGA1UEBhMCQ04xEjAQBgNVBAgMCUd1YW5nZG9uZzEMMAoGA1UECgwDNzc3MQwwCgYDVQQDDAM3NzcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCzQoGPL7ycwZeqt+TUP308IX1VgwN8H3O8gsBfkEb+K2RsoGgytPtRAgNCPgr6nc90AqC1O6Om/wsqdBHz1w1f6WJb25a0mh18W7c+D05/4cbcpD1xxtc8U2tYGoiTRvbHaApEJfaQ/dWKxRujFsoBYxcnavMoEKm8vSJ/jNRS/mEODQU5L0KGZHUbMAllJLsVYdRn8yvHcNasYkeJrsJwF3aUG45XxMNoN1h6xda7jhQZ5AFhNJpNph0hna5F4Gtf9jo8MMQ2p3eYQaGclvV/C/8n4dt+Wvb/SHeseeAv3UnemKsGDeikjJ4aunWp9TVMB59salUu1TPh8tjRWwpXAgMBAAGjggE+MIIBOjAfBgNVHSMEGDAWgBQGuR/VnbIM8cSEdELCMCXiCdpW2DAdBgNVHQ4EFgQUS+LsjNKsyRyHHiHGBo9tz2ulftEwbAYDVR0gBGUwYzBhBgsrBgEEAYGSSAIKAjBSMFAGCCsGAQUFBwIBFkRodHRwOi8vd3d3LmNuY2EubmV0L2NzL2tub3dsZWRnZS93aGl0ZXBhcGVyL2Nwcy9uZXRDQXRlc3RjZXJ0Y3BzLnBkZjAMBgNVHRMBAf8EAjAAMA4GA1UdDwEB/wQEAwIGwDBsBgNVHR8EZTBjMGGgX6Bdhi1odHRwOi8vdGVzdC5jbmNhLm5ldC9jcmwvQ0NTTkVUQ0FUMlN1YjFDQS5jcmyGLGh0dHA6Ly8xOTIuMTY4LjAuMjgvY3JsL0NDU05FVENBVDJTdWIxQ0EuY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQA7nJJqJa3PXXTw1tPzTxG6nxSirr+68+jHWHOvgwJ2EiW8vkl7ln+s3xf5H8cA6u3oKQ9C0lA597E2Y49BQ7m9q8YgLxpkT2RpTXaGtBKpKbZOCZAQZF0bD/4KEtaKH0Z9lSKRfQjknOjidrJvVs0AO4qCNAslboK0O7mhDgwjUr7dsiL6pwQZ7N646Z2G05xiLLeSU0+eeOU2s2Vla1aIqX9LHwB2vX4jMgZLLiF1FcFBkSZuHmaUOp3GNfdVms3JKpLUr91drelEadlRTNlmGpOUz4PQKXhIyMI+g5tO5pMrv/OyjM82RY2BQw3UmWFBIxbDor1vV64RiPvqfxTD"
	with Certificate(signcert_base64) as cert_obj:
		cert_obj.get_privatekey("12345678")
		signature=cert_obj.sign(tbs_data)
		print(cert_obj.get_subject())

if __name__ == '__main__':
	i = 0
	while True:
		i=i+1
		print(str(i)+' times')	
		#signedData()    #测试Signeddata签名
		#verify_signedData()    #测试signeddata验签
		#envlopedData()    #测试数字信封加密
		decrypt_envlopedData()    #测试数字信封解密
		#sign()#测试P1签名
		

